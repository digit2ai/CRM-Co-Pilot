{% extends "base.html" %}

{% block title %}{{ sprint.name }} - Sprint Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-calendar"></i> {{ sprint.name }}</h2>
                    <p class="text-muted">
                        <i class="fas fa-project-diagram"></i> {{ sprint.project.name }}
                        <span class="mx-2">â€¢</span>
                        <span class="badge badge-{{ 'success' if sprint.status == 'completed' else 'warning' if sprint.status == 'in-progress' else 'secondary' }}">
                            {{ sprint.status|title }}
                        </span>
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('all_sprints') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Sprints
                    </a>
                    <a href="{{ url_for('project_detail', project_id=sprint.project.id) }}" class="btn btn-info">
                        <i class="fas fa-project-diagram"></i> View Project
                    </a>
                    <button class="btn btn-primary" onclick="addUserStory()">
                        <i class="fas fa-plus"></i> Add Story
                    </button>
                </div>
            </div>

            <!-- Sprint Overview -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-bullseye"></i> Sprint Goal</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ sprint.goal or 'No goal specified for this sprint.' }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="text-muted">Sprint Metrics</h5>
                            <div class="row">
                                <div class="col-6">
                                    <h3 class="text-primary">{{ user_stories|length }}</h3>
                                    <small class="text-muted">Stories</small>
                                </div>
                                <div class="col-6">
                                    <h3 class="text-info">{{ sprint.story_points }}</h3>
                                    <small class="text-muted">Points</small>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-6">
                                    <h4 class="text-success">{{ user_stories|selectattr('status', 'equalto', 'Done')|list|length }}</h4>
                                    <small class="text-muted">Completed</small>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-warning">{{ user_stories|selectattr('status', 'equalto', 'in-progress')|list|length }}</h4>
                                    <small class="text-muted">In Progress</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            {% set completed_stories = user_stories|selectattr('status', 'equalto', 'Done')|list|length %}
            {% set total_stories = user_stories|length %}
            {% set progress_percentage = (completed_stories / total_stories * 100)|round if total_stories > 0 else 0 %}
            
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Sprint Progress</h6>
                        <span class="text-muted">{{ completed_stories }}/{{ total_stories }} stories completed</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_percentage }}%"></div>
                    </div>
                    <small class="text-muted">{{ progress_percentage }}% complete</small>
                </div>
            </div>

            <!-- User Stories Section -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-book"></i> User Stories</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" onclick="filterStories('all')">
                                All ({{ user_stories|length }})
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="filterStories('todo')">
                                Todo ({{ user_stories|selectattr('status', 'equalto', 'todo')|list|length }})
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="filterStories('in-progress')">
                                In Progress ({{ user_stories|selectattr('status', 'equalto', 'in-progress')|list|length }})
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="filterStories('Done')">
                                Done ({{ user_stories|selectattr('status', 'equalto', 'Done')|list|length }})
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if user_stories %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="10%">ID</th>
                                        <th width="35%">Title</th>
                                        <th width="15%">Epic</th>
                                        <th width="10%">Points</th>
                                        <th width="15%">Status</th>
                                        <th width="15%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="storiesTableBody">
                                    {% for story in user_stories %}
                                    <tr class="story-row" data-status="{{ story.status }}" data-story-id="{{ story.id }}">
                                        <td>
                                            <code>{{ story.story_id or story.id }}</code>
                                        </td>
                                        <td>
                                            <div class="story-title" onclick="viewStoryDetail({{ story.id }})">
                                                <strong>{{ story.title }}</strong>
                                                {% if story.description %}
                                                <br><small class="text-muted">{{ story.description[:80] }}{% if story.description|length > 80 %}...{% endif %}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge badge-light">{{ story.epic.name if story.epic else 'No Epic' }}</span>
                                        </td>
                                        <td>
                                            <span class="badge badge-info">{{ story.story_points or 0 }}</span>
                                        </td>
                                        <td>
                                            <select class="form-control form-control-sm status-select" data-story-id="{{ story.id }}" onchange="updateStoryStatus(this)">
                                                <option value="todo" {{ 'selected' if story.status == 'todo' else '' }}>Todo</option>
                                                <option value="in-progress" {{ 'selected' if story.status == 'in-progress' else '' }}>In Progress</option>
                                                <option value="Done" {{ 'selected' if story.status == 'Done' else '' }}>Done</option>
                                            </select>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-primary" onclick="viewStoryDetail({{ story.id }})" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary" onclick="editStory({{ story.id }})" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteStory({{ story.id }})" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No User Stories</h4>
                            <p class="text-muted mb-4">This sprint doesn't have any user stories yet. Add your first story to get started!</p>
                            <button class="btn btn-primary btn-lg" onclick="addUserStory()">
                                <i class="fas fa-plus"></i> Add First User Story
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sprint Details -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-info-circle"></i> Sprint Information</h6>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Duration:</dt>
                                <dd class="col-sm-8">{{ sprint.duration or 'Not specified' }}</dd>
                                
                                <dt class="col-sm-4">Epics:</dt>
                                <dd class="col-sm-8">{{ sprint.epics|length }}</dd>
                                
                                <dt class="col-sm-4">Total Points:</dt>
                                <dd class="col-sm-8">{{ sprint.story_points }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Status Breakdown</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="text-secondary">
                                        <i class="fas fa-circle"></i>
                                        <br><small>Todo</small>
                                        <br><strong>{{ user_stories|selectattr('status', 'equalto', 'todo')|list|length }}</strong>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-warning">
                                        <i class="fas fa-circle"></i>
                                        <br><small>In Progress</small>
                                        <br><strong>{{ user_stories|selectattr('status', 'equalto', 'in-progress')|list|length }}</strong>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-success">
                                        <i class="fas fa-circle"></i>
                                        <br><small>Done</small>
                                        <br><strong>{{ user_stories|selectattr('status', 'equalto', 'Done')|list|length }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.story-title {
    cursor: pointer;
}

.story-title:hover {
    color: #007bff;
}

.story-row {
    transition: all 0.2s ease;
}

.story-row:hover {
    background-color: #f8f9fa;
}

.status-select {
    min-width: 110px;
}
</style>

<script>
function filterStories(status) {
    const rows = document.querySelectorAll('.story-row');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    // Update button states
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Filter rows
    rows.forEach(row => {
        if (status === 'all' || row.getAttribute('data-status') === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function updateStoryStatus(selectElement) {
    const storyId = selectElement.getAttribute('data-story-id');
    const newStatus = selectElement.value;
    
    // Here you would make an API call to update the story status
    // For now, just update the row's data attribute
    const row = selectElement.closest('.story-row');
    row.setAttribute('data-status', newStatus);
    
    console.log(`Updating story ${storyId} to status: ${newStatus}`);
    // TODO: Implement API call to update story status
}

function viewStoryDetail(storyId) {
    window.location.href = `/user-story/${storyId}`;
}

function editStory(storyId) {
    alert('Edit story functionality coming soon!');
}

function deleteStory(storyId) {
    if (confirm('Are you sure you want to delete this user story?')) {
        alert('Delete story functionality coming soon!');
    }
}

function addUserStory() {
    alert('Add user story functionality coming soon!');
}
</script>
{% endblock %}