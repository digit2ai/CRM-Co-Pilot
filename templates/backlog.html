{% extends "base.html" %}

{% block title %}{{ project.name }} - Backlog{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-list-ul"></i> {{ project.name }} - Backlog</h2>
                    <p class="text-muted">Manage and prioritize user stories for this project</p>
                </div>
                <div>
                    <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Project
                    </a>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addStoryModal">
                        <i class="fas fa-plus"></i> Add User Story
                    </button>
                </div>
            </div>

            <!-- Sprint Filter -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <select class="form-control" id="sprintFilter">
                        <option value="">All Sprints</option>
                        {% for sprint in sprints %}
                        <option value="{{ sprint.id }}">{{ sprint.name }}</option>
                        {% endfor %}
                        <option value="unassigned">Unassigned Stories</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-control" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="todo">To Do</option>
                        <option value="in-progress">In Progress</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="searchStories" placeholder="Search stories...">
                </div>
            </div>

            <!-- User Stories Section -->
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-book"></i> User Stories</h4>
                    <span class="badge badge-primary">{{ user_stories|length }} Total Stories</span>
                </div>
                <div class="card-body">
                    {% if user_stories %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="storiesTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th width="5%">ID</th>
                                        <th width="30%">Title</th>
                                        <th width="15%">Status</th>
                                        <th width="10%">Points</th>
                                        <th width="15%">Sprint</th>
                                        <th width="15%">Assignee</th>
                                        <th width="10%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for story in user_stories %}
                                    <tr data-story-id="{{ story.id }}" data-sprint-id="{{ story.epic.sprint.id if story.epic and story.epic.sprint else 'unassigned' }}" data-status="{{ story.status }}">
                                        <td>
                                            <code>{{ story.story_id or story.id }}</code>
                                        </td>
                                        <td>
                                            <strong>{{ story.title }}</strong>
                                            {% if story.description %}
                                            <br><small class="text-muted">{{ story.description[:100] }}{% if story.description|length > 100 %}...{% endif %}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-{{ 'success' if story.status == 'Done' else 'warning' if story.status == 'in-progress' else 'secondary' }}">
                                                {{ story.status|title }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge badge-info">{{ story.story_points or 'Not estimated' }}</span>
                                        </td>
                                        <td>
                                            {% if story.epic and story.epic.sprint %}
                                                <small class="text-muted">{{ story.epic.sprint.name }}</small>
                                            {% else %}
                                                <span class="text-muted"><i>Unassigned</i></span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if story.assignee %}
                                                <span class="badge badge-light">{{ story.assignee }}</span>
                                            {% else %}
                                                <span class="text-muted"><i>Unassigned</i></span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-primary btn-sm" onclick="editStory({{ story.id }})" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-info btn-sm" onclick="viewStory({{ story.id }})" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="deleteStory({{ story.id }})" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No user stories found for this project</h5>
                            <p class="text-muted mb-4">Start by creating your first user story to track project requirements.</p>
                            <button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#addStoryModal">
                                <i class="fas fa-plus"></i> Create First User Story
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Summary Cards -->
            {% if user_stories %}
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Stories</h5>
                            <h2 class="text-primary">{{ user_stories|length }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Completed</h5>
                            <h2 class="text-success">{{ user_stories|selectattr('status', 'equalto', 'Done')|list|length }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">In Progress</h5>
                            <h2 class="text-warning">{{ user_stories|selectattr('status', 'equalto', 'in-progress')|list|length }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Points</h5>
                            <h2 class="text-info">{{ user_stories|sum(attribute='story_points') or 0 }}</h2>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Story Modal (Basic) -->
<div class="modal fade" id="addStoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User Story</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-muted">
                    <i class="fas fa-info-circle"></i> 
                    User story creation functionality will be available once the full user story management system is implemented.
                </p>
                <p class="text-muted">For now, you can view and manage existing user stories from this backlog view.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Basic filtering functionality
document.addEventListener('DOMContentLoaded', function() {
    const sprintFilter = document.getElementById('sprintFilter');
    const statusFilter = document.getElementById('statusFilter');
    const searchInput = document.getElementById('searchStories');
    const tableRows = document.querySelectorAll('#storiesTable tbody tr');

    function filterTable() {
        const sprintValue = sprintFilter.value;
        const statusValue = statusFilter.value;
        const searchValue = searchInput.value.toLowerCase();

        tableRows.forEach(row => {
            const sprintId = row.getAttribute('data-sprint-id');
            const status = row.getAttribute('data-status');
            const text = row.textContent.toLowerCase();

            let showRow = true;

            // Sprint filter
            if (sprintValue && sprintValue !== sprintId) {
                showRow = false;
            }

            // Status filter
            if (statusValue && statusValue !== status) {
                showRow = false;
            }

            // Search filter
            if (searchValue && !text.includes(searchValue)) {
                showRow = false;
            }

            row.style.display = showRow ? '' : 'none';
        });
    }

    sprintFilter.addEventListener('change', filterTable);
    statusFilter.addEventListener('change', filterTable);
    searchInput.addEventListener('input', filterTable);
});

// Placeholder functions for future functionality
function editStory(storyId) {
    alert('Edit story functionality coming soon! Story ID: ' + storyId);
}

function viewStory(storyId) {
    alert('View story details functionality coming soon! Story ID: ' + storyId);
}

function deleteStory(storyId) {
    if (confirm('Delete story functionality coming soon! Would you like to proceed with Story ID: ' + storyId + '?')) {
        alert('Delete functionality will be implemented soon.');
    }
}
</script>
{% endblock %}
