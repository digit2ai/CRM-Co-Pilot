{% extends "base.html" %}

{% block title %}Backlog - {{ project.name }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h2>Product Backlog - {{ project.name }}</h2>
        <p style="color: #6b778c;">Manage and assign user stories to sprints</p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <button class="btn btn-success" onclick="showModal('createStoryModal')">+ Add User Story</button>
        <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-secondary">← Back to Project</a>
    </div>
</div>

<!-- Filter and Search -->
<div class="card">
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <input type="text" id="searchStories" class="form-control" placeholder="Search stories..." style="max-width: 300px;">
        <select id="filterStatus" class="form-control" style="max-width: 150px;">
            <option value="">All Status</option>
            <option value="todo">To Do</option>
            <option value="in-progress">In Progress</option>
            <option value="done">Done</option>
        </select>
        <select id="filterSprint" class="form-control" style="max-width: 200px;">
            <option value="">All Sprints</option>
            <option value="unassigned">Unassigned</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
    </div>
</div>

<!-- Backlog Stories -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>User Stories</h3>
        <div id="storyCount" style="color: #6b778c; font-size: 0.9rem;"></div>
    </div>
    <div id="storiesContainer">
        <!-- Stories will be loaded here -->
    </div>
</div>

<!-- Create Story Modal -->
<div id="createStoryModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('createStoryModal')">&times;</span>
        <h3>Create New User Story</h3>
        <form id="createStoryForm">
            <div class="form-group">
                <label for="storyTitle">Title *</label>
                <input type="text" id="storyTitle" class="form-control" required placeholder="As a user, I want...">
            </div>
            <div class="form-group">
                <label for="storyDescription">Description</label>
                <textarea id="storyDescription" class="form-control" rows="3" placeholder="Detailed description of the user story"></textarea>
            </div>
            <div class="form-group">
                <label for="storyPoints">Story Points</label>
                <select id="storyPoints" class="form-control">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="5">5</option>
                    <option value="8">8</option>
                    <option value="13">13</option>
                </select>
            </div>
            <div class="form-group">
                <label for="storyStatus">Status</label>
                <select id="storyStatus" class="form-control">
                    <option value="todo" selected>To Do</option>
                    <option value="in-progress">In Progress</option>
                    <option value="done">Done</option>
                </select>
            </div>
            <div class="form-group">
                <label for="storyAssignee">Assignee</label>
                <input type="text" id="storyAssignee" class="form-control" placeholder="Team member name">
            </div>
            <div class="form-group">
                <label for="acceptanceCriteria">Acceptance Criteria</label>
                <div id="criteriaContainer">
                    <div class="criteria-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="text" class="form-control criteria-input" placeholder="Acceptance criterion">
                        <button type="button" class="btn btn-danger" onclick="removeCriteria(this)" style="padding: 0.5rem;">×</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addCriteria()">+ Add Criterion</button>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="hideModal('createStoryModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Story</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Story Modal -->
<div id="editStoryModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('editStoryModal')">&times;</span>
        <h3>Edit User Story</h3>
        <form id="editStoryForm">
            <input type="hidden" id="editStoryId">
            <div class="form-group">
                <label for="editStoryTitle">Title *</label>
                <input type="text" id="editStoryTitle" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="editStoryDescription">Description</label>
                <textarea id="editStoryDescription" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="editStoryPoints">Story Points</label>
                <select id="editStoryPoints" class="form-control">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="5">5</option>
                    <option value="8">8</option>
                    <option value="13">13</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editStoryStatus">Status</label>
                <select id="editStoryStatus" class="form-control">
                    <option value="todo">To Do</option>
                    <option value="in-progress">In Progress</option>
                    <option value="done">Done</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editStoryAssignee">Assignee</label>
                <input type="text" id="editStoryAssignee" class="form-control">
            </div>
            <div class="form-group">
                <label for="editStorySprint">Sprint Assignment</label>
                <select id="editStorySprint" class="form-control">
                    <option value="">Unassigned</option>
                    <!-- Sprint options will be populated dynamically -->
                </select>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="hideModal('editStoryModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Story</button>
            </div>
        </form>
    </div>
</div>

<style>
.story-card {
    background: white;
    border-radius: 8px;
    border: 1px solid #dfe1e6;
    padding: 1rem;
    margin-bottom: 0.5rem;
    transition: all 0.2s;
    cursor: pointer;
}

.story-card:hover {
    border-color: #0052cc;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.story-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
}

.story-id {
    background: #0052cc;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
}

.story-points {
    background: #ffab00;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 50%;
    font-weight: bold;
    min-width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.story-title {
    font-weight: 600;
    margin: 0.5rem 0;
    color: #172b4d;
}

.story-meta {
    display: flex;
    gap: 1rem;
    align-items: center;
    font-size: 0.8rem;
    color: #6b778c;
    flex-wrap: wrap;
}

.story-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.criteria-item {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6b778c;
}

.empty-state h4 {
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
const projectId = {{ project.id }};
let allStories = [];
let allSprints = [];

// Load all data
async function loadBacklogData() {
    try {
        // Load stories and sprints
        const [stories, sprints] = await Promise.all([
            makeRequest(`/api/projects/${projectId}/stories`),
            makeRequest(`/api/projects/${projectId}/sprints`)
        ]);
        
        allStories = stories;
        allSprints = sprints;
        
        populateSprintOptions();
        renderStories(allStories);
        updateStoryCount(allStories.length);
        
    } catch (error) {
        console.error('Failed to load backlog data:', error);
        showAlert('Failed to load backlog data', 'error');
    }
}

function populateSprintOptions() {
    const sprintSelect = document.getElementById('filterSprint');
    const editSprintSelect = document.getElementById('editStorySprint');
    
    // Clear existing options except default ones
    while (sprintSelect.children.length > 2) {
        sprintSelect.removeChild(sprintSelect.lastChild);
    }
    while (editSprintSelect.children.length > 1) {
        editSprintSelect.removeChild(editSprintSelect.lastChild);
    }
    
    allSprints.forEach(sprint => {
        const option1 = document.createElement('option');
        option1.value = sprint.id;
        option1.textContent = sprint.name;
        sprintSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = sprint.id;
        option2.textContent = sprint.name;
        editSprintSelect.appendChild(option2);
    });
}

function renderStories(stories) {
    const container = document.getElementById('storiesContainer');
    
    if (stories.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <h4>No user stories found</h4>
                <p>Create your first user story to get started!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    stories.forEach(story => {
        const sprintName = story.sprint_name || 'Unassigned';
        const statusBadge = getStatusBadge(story.status);
        
        html += `
            <div class="story-card" onclick="editStory(${story.id})">
                <div class="story-header">
                    <div class="story-id">${story.story_id || 'US-' + story.id}</div>
                    <div class="story-points">${story.story_points}</div>
                </div>
                <div class="story-title">${story.title}</div>
                <div class="story-meta">
                    ${statusBadge}
                    <span>📋 ${sprintName}</span>
                    ${story.assignee ? `<span>👤 ${story.assignee}</span>` : ''}
                </div>
                <div class="story-actions" onclick="event.stopPropagation();">
                    <button class="btn btn-secondary" onclick="editStory(${story.id})" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">Edit</button>
                    <button class="btn btn-danger" onclick="deleteStory(${story.id})" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">Delete</button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function getStatusBadge(status) {
    const statusMap = {
        'todo': '<span class="status-badge status-planning">To Do</span>',
        'in-progress': '<span class="status-badge status-in-progress">In Progress</span>',
        'done': '<span class="status-badge status-completed">Done</span>'
    };
    return statusMap[status] || '<span class="status-badge status-planning">Unknown</span>';
}

function updateStoryCount(count) {
    document.getElementById('storyCount').textContent = `${count} user stories`;
}

// Filter functionality
function filterStories() {
    const searchTerm = document.getElementById('searchStories').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const sprintFilter = document.getElementById('filterSprint').value;
    
    let filtered = allStories.filter(story => {
        const matchesSearch = !searchTerm || 
            story.title.toLowerCase().includes(searchTerm) ||
            story.description.toLowerCase().includes(searchTerm);
        
        const matchesStatus = !statusFilter || story.status === statusFilter;
        
        const matchesSprint = !sprintFilter || 
            (sprintFilter === 'unassigned' && !story.sprint_id) ||
            (sprintFilter !== 'unassigned' && story.sprint_id == sprintFilter);
        
        return matchesSearch && matchesStatus && matchesSprint;
    });
    
    renderStories(filtered);
    updateStoryCount(filtered.length);
}

function clearFilters() {
    document.getElementById('searchStories').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterSprint').value = '';
    renderStories(allStories);
    updateStoryCount(allStories.length);
}

// Event listeners for filters
document.getElementById('searchStories').addEventListener('input', filterStories);
document.getElementById('filterStatus').addEventListener('change', filterStories);
document.getElementById('filterSprint').addEventListener('change', filterStories);

// Create story functionality
function addCriteria() {
    const container = document.getElementById('criteriaContainer');
    const criteriaItem = document.createElement('div');
    criteriaItem.className = 'criteria-item';
    criteriaItem.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
    criteriaItem.innerHTML = `
        <input type="text" class="form-control criteria-input" placeholder="Acceptance criterion">
        <button type="button" class="btn btn-danger" onclick="removeCriteria(this)" style="padding: 0.5rem;">×</button>
    `;
    container.appendChild(criteriaItem);
}

function removeCriteria(button) {
    button.parentElement.remove();
}

document.getElementById('createStoryForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const criteriaInputs = document.querySelectorAll('#createStoryModal .criteria-input');
    const acceptanceCriteria = Array.from(criteriaInputs)
        .map(input => input.value.trim())
        .filter(value => value.length > 0);
    
    const storyData = {
        title: document.getElementById('storyTitle').value,
        description: document.getElementById('storyDescription').value,
        story_points: parseInt(document.getElementById('storyPoints').value),
        status: document.getElementById('storyStatus').value,
        assignee: document.getElementById('storyAssignee').value,
        acceptance_criteria: acceptanceCriteria,
        project_id: projectId
    };
    
    try {
        await makeRequest('/api/stories', 'POST', storyData);
        showAlert('User story created successfully!');
        hideModal('createStoryModal');
        document.getElementById('createStoryForm').reset();
        loadBacklogData();
    } catch (error) {
        // Error already shown by makeRequest
    }
});

// Edit story functionality
async function editStory(storyId) {
    try {
        const story = allStories.find(s => s.id === storyId);
        if (!story) return;
        
        document.getElementById('editStoryId').value = story.id;
        document.getElementById('editStoryTitle').value = story.title;
        document.getElementById('editStoryDescription').value = story.description || '';
        document.getElementById('editStoryPoints').value = story.story_points;
        document.getElementById('editStoryStatus').value = story.status;
        document.getElementById('editStoryAssignee').value = story.assignee || '';
        document.getElementById('editStorySprint').value = story.sprint_id || '';
        
        showModal('editStoryModal');
    } catch (error) {
        showAlert('Failed to load story details', 'error');
    }
}

document.getElementById('editStoryForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const storyId = document.getElementById('editStoryId').value;
    const storyData = {
        title: document.getElementById('editStoryTitle').value,
        description: document.getElementById('editStoryDescription').value,
        story_points: parseInt(document.getElementById('editStoryPoints').value),
        status: document.getElementById('editStoryStatus').value,
        assignee: document.getElementById('editStoryAssignee').value,
        sprint_id: document.getElementById('editStorySprint').value || null
    };
    
    try {
        await makeRequest(`/api/stories/${storyId}`, 'PUT', storyData);
        showAlert('User story updated successfully!');
        hideModal('editStoryModal');
        loadBacklogData();
    } catch (error) {
        // Error already shown by makeRequest
    }
});

// Delete story
async function deleteStory(storyId) {
    if (confirm('Are you sure you want to delete this user story? This action cannot be undone.')) {
        try {
            await makeRequest(`/api/stories/${storyId}`, 'DELETE');
            showAlert('User story deleted successfully!');
            loadBacklogData();
        } catch (error) {
            // Error already shown by makeRequest
        }
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', loadBacklogData);
</script>
{% endblock %}