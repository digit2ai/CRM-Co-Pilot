{% extends "base.html" %}

{% block title %}{{ project.name }} - Project Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>{{ project.name }}</h2>
                    <p class="text-muted">{{ project.description }}</p>
                </div>
                <div>
                    <button class="btn btn-success" onclick="addSprint()">
                        <i class="fas fa-plus"></i> Add Sprint
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Project Metrics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Sprints</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSprints">{{ project.sprints|length }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-calendar fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">User Stories</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="userStories">Loading...</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-book fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Story Points</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="storyPoints">{{ project.sprints|sum(attribute='story_points') or 0 }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-star fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Completion Rate</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="completionRate">0%</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-chart-pie fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sprints Section -->
            <div class="card">
                <div class="card-header">
                    <h4>Sprints</h4>
                </div>
                <div class="card-body">
                    {% if project.sprints %}
                        {% for sprint in project.sprints %}
                        <!-- Make each sprint card clickable -->
                        <div class="card mb-3 sprint-card" data-sprint-id="{{ sprint.id }}" onclick="viewSprint({{ sprint.id }})">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h5 class="card-title mb-1">{{ sprint.name }}</h5>
                                        <p class="card-text text-muted mb-2">{{ sprint.goal }}</p>
                                        <div class="d-flex align-items-center">
                                            <span class="badge badge-{{ 'success' if sprint.status == 'completed' else 'warning' if sprint.status == 'in-progress' else 'secondary' }} mr-2">
                                                {{ sprint.status|title }}
                                            </span>
                                            <small class="text-muted">
                                                {{ sprint.duration }} • {{ sprint.epics|length }} epic{{ 's' if sprint.epics|length != 1 else '' }} • {{ sprint.story_points }} points
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-right">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-primary btn-sm" onclick="viewSprint({{ sprint.id }}); event.stopPropagation();">
                                                <i class="fas fa-eye"></i> View Stories
                                            </button>
                                            <button class="btn btn-secondary btn-sm" onclick="editSprint({{ sprint.id }}); event.stopPropagation();">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteSprint({{ sprint.id }}); event.stopPropagation();">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- User Stories Preview -->
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-book"></i> 
                                                {% set total_stories = 0 %}
                                                {% for epic in sprint.epics %}
                                                    {% set total_stories = total_stories + epic.user_stories|length %}
                                                {% endfor %}
                                                {{ total_stories }} user stories
                                            </small>
                                            <div class="progress" style="width: 200px; height: 6px;">
                                                {% set completed_stories = 0 %}
                                                {% for epic in sprint.epics %}
                                                    {% for story in epic.user_stories %}
                                                        {% if story.status == 'Done' %}
                                                            {% set completed_stories = completed_stories + 1 %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endfor %}
                                                {% set progress = ((completed_stories / total_stories) * 100)|round if total_stories > 0 else 0 %}
                                                <div class="progress-bar bg-success" style="width: {{ progress }}%"></div>
                                            </div>
                                            <small class="text-muted">{{ progress if total_stories > 0 else 0 }}% complete</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No sprints found</h5>
                            <p class="text-muted">Create your first sprint to start organizing your work!</p>
                            <button class="btn btn-primary" onclick="addSprint()">
                                <i class="fas fa-plus"></i> Create First Sprint
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sprint-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 4px solid #e3e6f0;
}

.sprint-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-left-color: #4e73df;
}

.sprint-card[data-sprint-status="completed"] {
    border-left-color: #1cc88a;
}

.sprint-card[data-sprint-status="in-progress"] {
    border-left-color: #f6c23e;
}

.sprint-card[data-sprint-status="planned"] {
    border-left-color: #36b9cc;
}

.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.text-gray-800 {
    color: #5a5c69 !important;
}

.text-gray-300 {
    color: #dddfeb !important;
}
</style>

<script>
// Load project analytics
document.addEventListener('DOMContentLoaded', function() {
    loadProjectAnalytics();
    
    // Add status data attributes for styling
    document.querySelectorAll('.sprint-card').forEach(card => {
        const statusBadge = card.querySelector('.badge');
        if (statusBadge) {
            const status = statusBadge.textContent.toLowerCase().trim();
            card.setAttribute('data-sprint-status', status);
        }
    });
});

function loadProjectAnalytics() {
    const projectId = {{ project.id }};
    
    fetch(`/api/analytics/${projectId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('userStories').textContent = data.total_stories;
            document.getElementById('completionRate').textContent = data.completion_rate + '%';
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
            document.getElementById('userStories').textContent = '0';
            document.getElementById('completionRate').textContent = '0%';
        });
}

function viewSprint(sprintId) {
    window.location.href = `/sprint/${sprintId}`;
}

function editSprint(sprintId) {
    alert('Edit sprint functionality coming soon!');
}

function deleteSprint(sprintId) {
    if (confirm('Are you sure you want to delete this sprint? This will also delete all associated epics and user stories.')) {
        fetch(`/api/sprints/${sprintId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error deleting sprint:', error);
            alert('Error deleting sprint. Please try again.');
        });
    }
}

function addSprint() {
    alert('Add sprint functionality coming soon!');
}
</script>
{% endblock %}
